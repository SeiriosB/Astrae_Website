---
layout: default
title: News
---

<section class="news-page">
  <!-- Calendar -->
  <div class="calendar">
    <div class="calendar-header">
      <button onclick="prevMonth()">&lt;</button>
      <h3 id="calendar-month"></h3>
      <button onclick="nextMonth()"> &gt;</button>
    </div>
    <div id="calendar-grid" class="calendar-grid"></div>
    
    <!-- Constellations Section -->
    <div class="constellations-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
      <h4 style="margin: 0 0 10px 0; font-size: 1em; color: #444;">Bright Constellations (21:00 - 04:00)</h4>
      <p id="constellation-list" style="margin: 0; font-size: 0.9em; color: #666;"></p>
    </div>

    <!-- Messier Marathon Section -->
    <div class="messier-section" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
      <h4 style="margin: 0 0 10px 0; font-size: 1em; color: #444;">Messier Marathon (21:00 - 04:00)</h4>
      <div id="messier-list" style="margin: 0; font-size: 0.9em; color: #666; line-height: 1.6;"></div>
    </div>
  </div>

  <!-- News feed -->
  <div class="news-feed">
    <h2 id="news-heading">News for this Month</h2>
    <div id="news-list">
      <!-- Content populated by JS -->
    </div>
  </div>
</section>

<!-- Pass posts data into JS -->
<script>
  // Combined posts for Calendar dots
  const posts = [
    {% for post in site.posts %}
      {
        title: {{ post.title | jsonify }},
        url: "{{ post.url | relative_url }}",
        date: "{{ post.date | date: '%Y-%m-%d' }}",
        category: "{{ post.categories | first }}"
      },
    {% endfor %}
    {% if site.data.news %}
      {% for news in site.data.news %}
        {
          title: {{ news.title | jsonify }},
          url: null,
          date: "{{ news.date | date: '%Y-%m-%d' }}",
          category: "{{ news.category | default: 'news' }}" 
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];

  // Specific News Data for the Feed
  const allNews = [
    {% if site.data.news %}
      {% assign sorted_news = site.data.news | sort: "date" | reverse %}
      {% for news in sorted_news %}
        {
          title: {{ news.title | jsonify }},
          date: "{{ news.date | date: '%Y-%m-%d' }}",
          displayDate: "{{ news.date | date: '%b %d' }}",
          description: {{ news.description | jsonify }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];

  // Constellation Data
  const constellationsData = [
    {% if site.data.constellations %}
      {% for item in site.data.constellations %}
        {
          month: {{ item.month }},
          names: {{ item.names | jsonify }}
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];

  // Messier Data
  const messierData = [
    {% if site.data.messier %}
      {% for item in site.data.messier %}
        {
          month: {{ item.month }},
          objects: [
            {% for obj in item.objects %}
              {
                name: {{ obj.name | jsonify }},
                common_name: {{ obj.common_name | jsonify }},
                type: {{ obj.type | jsonify }},
                constellation: {{ obj.constellation | jsonify }},
                mag: {{ obj.mag | jsonify }},
                size: {{ obj.size | jsonify }}
              }{% unless forloop.last %},{% endunless %}
            {% endfor %}
          ]
        }{% unless forloop.last %},{% endunless %}
      {% endfor %}
    {% endif %}
  ];
</script>

<!-- SunCalc Library -->
<script src="{{ 'assets/js/suncalc.js' | relative_url }}"></script>

<script>
  const categoriesColors = {
    news: "green",
    pictures: "purple",
    default: "gray"
  };

  let currentDate = new Date();

  // Bangalore Coordinates
  const LAT = 12.9716;
  const LON = 77.5946;

  function formatTime(date) {
    if (!date) return "--:--";
    try {
      const ist = new Intl.DateTimeFormat('en-GB', { 
          timeZone: 'Asia/Kolkata', 
          hour: '2-digit', minute: '2-digit', hour12: false 
      }).format(date);
      
      const gmt = new Intl.DateTimeFormat('en-GB', { 
          timeZone: 'GMT', 
          hour: '2-digit', minute: '2-digit', hour12: false 
      }).format(date);
      
      return `${ist} IST (${gmt} GMT)`;
    } catch (e) {
      return date.toLocaleTimeString(); 
    }
  }

  function renderNews() {
    const month = currentDate.getMonth(); // 0-11
    const year = currentDate.getFullYear();
    
    // Filter news for current month/year
    const monthlyNews = allNews.filter(item => {
      const d = new Date(item.date);
      return d.getMonth() === month && d.getFullYear() === year;
    });

    const newsList = document.getElementById("news-list");
    const newsHeading = document.getElementById("news-heading");
    
    // Update Heading
    const monthName = currentDate.toLocaleString("default", { month: "long" });
    newsHeading.innerText = `News for ${monthName} ${year}`;

    newsList.innerHTML = "";

    if (monthlyNews.length === 0) {
      newsList.innerHTML = "<p>No news for this month.</p>";
      return;
    }

    monthlyNews.forEach(item => {
      const div = document.createElement("div");
      div.className = "news-item";
      
      div.innerHTML = `
        <div class="news-date">${item.displayDate}</div>
        <div class="news-content">
          <h4>${item.title}</h4>
          <p>${item.description}</p>
        </div>
      `;
      newsList.appendChild(div);
    });
  }

  function renderConstellations() {
    const month = currentDate.getMonth() + 1; // 1-12
    const listEl = document.getElementById("constellation-list");
    
    const data = constellationsData.find(c => c.month === month);
    
    if (data && data.names && data.names.length > 0) {
      listEl.innerText = data.names.join(", ");
    } else {
      listEl.innerText = "No data available.";
    }
  }

  function renderMessier() {
    const month = currentDate.getMonth() + 1; // 1-12
    const listEl = document.getElementById("messier-list");
    listEl.innerHTML = "";
    
    const data = messierData.find(m => m.month === month);
    
    if (data && data.objects && data.objects.length > 0) {
      data.objects.forEach((obj, index) => {
        const span = document.createElement("span");
        
        // Display Text: Just the code (e.g., M43)
        span.innerText = obj.name;
        
        // Tooltip:
        // Common Name (if any)
        // Type
        // Constellation
        // Magnitude: ...
        // Dimensions: ...
        let tooltip = "";
        if (obj.common_name) tooltip += `${obj.common_name}\n`;
        tooltip += `${obj.type}\n`;
        tooltip += `${obj.constellation}\n`;
        tooltip += `Magnitude: ${obj.mag}\n`;
        tooltip += `Dimensions: ${obj.size}`;
        
        span.title = tooltip;
        span.style.cursor = "help";
        span.style.borderBottom = "1px dotted #999";
        
        listEl.appendChild(span);
        
        if (index < data.objects.length - 1) {
          listEl.appendChild(document.createTextNode(", "));
        }
      });
    } else {
      listEl.innerText = "No data available.";
    }
  }

  function renderCalendar() {
    const month = currentDate.getMonth();
    const year = currentDate.getFullYear();

    // Update News Feed, Constellations & Messier whenever calendar renders
    renderNews();
    renderConstellations();
    renderMessier();

    // Month label
    document.getElementById("calendar-month").innerText =
      currentDate.toLocaleString("default", { month: "long" }) + " " + year;

    // First day and days count
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    const grid = document.getElementById("calendar-grid");
    grid.innerHTML = "";

    // Weekday headers
    const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    weekdays.forEach(day => {
      const dayHeader = document.createElement("div");
      dayHeader.className = "calendar-weekday";
      dayHeader.innerText = day;
      grid.appendChild(dayHeader);
    });

    // Empty slots for days before 1st
    for (let i = 0; i < firstDay; i++) {
      grid.appendChild(document.createElement("div"));
    }

    // Actual days
    for (let day = 1; day <= daysInMonth; day++) {
      const cell = document.createElement("div");
      cell.className = "calendar-day";
      cell.innerText = day;

      const dateObj = new Date(year, month, day, 12, 0, 0); // Noon
      
      // Moon Phase Illumination
      let percent = 0;
      let moonIllum = null;
      if (window.SunCalc) {
        moonIllum = SunCalc.getMoonIllumination(dateObj);
        percent = Math.round(moonIllum.fraction * 100);
      }
      
      // Gradient background
      cell.style.background = `linear-gradient(90deg, rgba(200, 200, 220, 0.5) ${percent}%, white ${percent}%)`;

      // Tooltip with Sun/Moon times
      if (window.SunCalc && moonIllum) {
        const sunTimes = SunCalc.getTimes(dateObj, LAT, LON);
        const moonTimes = SunCalc.getMoonTimes(dateObj, LAT, LON);
        
        const tooltip = [
          `Sun Rise: ${formatTime(sunTimes.sunrise)}`,
          `Sun Set: ${formatTime(sunTimes.sunset)}`,
          `Moon Rise: ${formatTime(moonTimes.rise)}`,
          `Moon Set: ${formatTime(moonTimes.set)}`
        ];

        // Check for specific Moon Phase
        // SunCalc phases: 0=New, 0.25=First Quarter, 0.5=Full, 0.75=Last Quarter
        const p = moonIllum.phase;
        const threshold = 0.03;
        
        if (p < threshold || p > 1 - threshold) tooltip.push("New Moon");
        else if (Math.abs(p - 0.25) < threshold) tooltip.push("First Quarter");
        else if (Math.abs(p - 0.50) < threshold) tooltip.push("Full Moon");
        else if (Math.abs(p - 0.75) < threshold) tooltip.push("Last Quarter");
        
        cell.title = tooltip.join('\n');
      }

      // Match posts for this date
      const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
      const todaysPosts = posts.filter(p => p.date === dateKey);

      if (todaysPosts.length > 0) {
        const dots = document.createElement("div");
        dots.className = "dots";
        todaysPosts.forEach(p => {
          const dot = document.createElement("span");
          dot.style.backgroundColor = categoriesColors[p.category] || categoriesColors.default;
          // Append post title to tooltip if it exists
          if (cell.title) {
             // cell.title += '\n\n' + p.title; 
          } else {
             cell.title = p.title;
          }
          // The dot itself has a title too, but the cell title covers the whole area
          dots.appendChild(dot);
        });
        cell.appendChild(dots);

        // Make date clickable if there is a valid link
        const validLinkPost = todaysPosts.filter(p => p.url)[0];
        if (validLinkPost) {
          cell.onclick = () => {
            window.location.href = validLinkPost.url;
          };
          cell.style.cursor = "pointer";
        }
      }

      grid.appendChild(cell);
    }
  }

  function prevMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  }

  document.addEventListener("DOMContentLoaded", renderCalendar);
</script>

<!-- CSS -->
<style>
.news-page {
  display: grid;
  grid-template-columns: 30% 70%;
  gap: 20px;
  padding: 20px;
}

/* Calendar */
.calendar {
  background: #f9f9f9;
  padding: 15px;
  border-radius: 8px;
  border: 1px solid #ddd;
  align-self: start;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
}

.calendar-weekday {
  text-align: center;
  font-weight: bold;
  font-size: 0.8em;
  color: #777;
  padding-bottom: 5px;
}

.calendar-day {
  padding: 8px;
  background: #fff;
  border: 1px solid #eee;
  border-radius: 4px;
  text-align: center;
  font-size: 0.9em;
  position: relative;
}

.dots {
  display: flex;
  justify-content: center;
  gap: 2px;
  margin-top: 3px;
}

.dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  display: inline-block;
}

/* News feed */
.news-feed h2 {
  margin-bottom: 20px;
}

.news-item {
  display: flex;
  align-items: flex-start;
  border-bottom: 1px solid #eee;
  padding: 10px 0;
}

.news-date {
  flex: 0 0 80px;
  font-weight: bold;
  color: #444;
}

.news-content {
  flex: 1;
}

.news-content h4 {
  margin: 0;
  font-size: 1.1em;
}

.news-thumb {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
  margin: 8px 0;
}

.news-content p {
  margin: 5px 0 0;
  color: #666;
  font-size: 0.9em;
}
</style>